<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xmlns:security="http://www.springframework.org/schema/security"
	xmlns:p="http://www.springframework.org/schema/p" 
	xsi:schemaLocation="http://www.springframework.org/schema/beans 
	   		http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
			http://www.springframework.org/schema/security 
			http://www.springframework.org/schema/security/spring-security-3.1.xsd">
		<bean id="ajaxTimeoutRedirectFilter" class="mx.com.sit.gescomer.auth.AjaxTimeoutRedirectFilter">
			<property name="customSessionExpiredErrorCode" value="901"/>
		</bean>
	
	
	<!-- This is where we configure Spring-Security  -->
	<security:http auto-config="false" use-expressions="true" access-denied-page="/init.html"
			entry-point-ref="authenticationEntryPoint"  disable-url-rewriting="true" >
		<security:intercept-url pattern="/index.html" access="isAuthenticated()" />
		<security:custom-filter ref="ajaxTimeoutRedirectFilter" after="EXCEPTION_TRANSLATION_FILTER"/>
		<security:logout delete-cookies="JSESSIONID" invalidate-session="true" logout-success-url="/init.html" logout-url="/logout.html"/>
		<!-- 
			Querying the SessionRegistry for currently authenticated users and their sessions
			http://static.springsource.org/spring-security/site/docs/3.1.x/reference/session-mgmt.html#list-authenticated-principals 
		-->
		<security:custom-filter ref="authenticationFilter" position="FORM_LOGIN_FILTER" />
		<security:custom-filter ref="concurrencyFilter" position="CONCURRENT_SESSION_FILTER"/>
		<security:session-management session-authentication-strategy-ref="sas"/>
	</security:http>
	
	<bean id="authenticationFilter" class="org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter"
	    p:sessionAuthenticationStrategy-ref="sas"
	    p:filterProcessesUrl="/init"
	    p:authenticationManager-ref="authenticationManager" 
  		p:authenticationFailureHandler-ref="customAuthenticationFailureHandler"
  		p:authenticationSuccessHandler-ref="customAuthenticationSuccessHandler" />

 	<!-- We just actually need to set the default failure url here -->
 	<bean id="customAuthenticationFailureHandler" class="org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler"
 		p:defaultFailureUrl="/errorLogin.html?error=true"  />
 		
 	 <!-- We just actually need to set the default target url here -->
 	<bean id="customAuthenticationSuccessHandler" class="org.springframework.security.web.authentication.SimpleUrlAuthenticationSuccessHandler"
 		p:defaultTargetUrl="/"  />
 		
	<!-- The AuthenticationEntryPoint is responsible for redirecting the user to a particular page, like a login page,
 			whenever the server sends back a response requiring authentication -->
 	<!-- See Spring-Security Reference 5.4.1 for more info -->
 	<bean id="authenticationEntryPoint" class="org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint"
	 	p:loginFormUrl="/blank.html" />

	<!-- Declare an authentication-manager to use a custom userDetailsService -->
	<!-- It's important to set the alias here because it's used by the authenticationFilter -->
	<security:authentication-manager alias="authenticationManager">
	        <security:authentication-provider  ref="customAuthProvider"  />
	   
	</security:authentication-manager>
	
	

	<!-- CUSTOM AUTHENTICATION WEB SERVICE PROVIDER-->
	<bean id="customAuthProvider"  class="mx.com.sit.gescomer.auth.CustomAuthenticationProvider" >
		 <property name="passwordEncoder" ref="passwordEncoder" />
	</bean>
		
	<bean id="passwordEncoder" class="org.springframework.security.authentication.encoding.Md5PasswordEncoder" />
	

	
	<!-- Filter required by concurrent session handling package 
			The ConcurrentSessionFilter requires two properties, sessionRegistry, which generally points to an 
			instance of SessionRegistryImpl, and expiredUrl, which points to the page to display when a session has expired.
			See: http://static.springsource.org/spring-security/site/docs/3.1.x/reference/session-mgmt.html#list-authenticated-principals -->
	<bean id="concurrencyFilter" class="org.springframework.security.web.session.ConcurrentSessionFilter"
		  	p:sessionRegistry-ref="sessionRegistry" 
		  	p:expiredUrl="/concurrentSession.html" />
	
	<!--  Defines a concrete concurrent control strategy 
			 Checks whether the user in question should be allowed to proceed, by comparing the number of 
			 sessions they already have active with the configured maximumSessions value. The SessionRegistry 
			 is used as the source of data on authenticated users and session data.
			 See: http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/web/authentication/session/ConcurrentSessionControlStrategy.html-->
	<bean id="sas" class="org.springframework.security.web.authentication.session.ConcurrentSessionControlStrategy"
	 		p:maximumSessions="1" >
	 		<constructor-arg name="sessionRegistry" ref="sessionRegistry" />
	</bean>

	<!-- Maintains a registry of SessionInformation instances
		   See: http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/session/SessionRegistry.html -->
	<bean id="sessionRegistry" class="org.springframework.security.core.session.SessionRegistryImpl" />	
</beans>
